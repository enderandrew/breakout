Function.prototype.bind||(Function.prototype.bind=function(t){var i=[].slice,e=i.call(arguments,1),n=this,s=function(){},r=function(){return n.apply(this instanceof s?this:t||{},e.concat(i.call(arguments)))};return s.prototype=n.prototype,r.prototype=new s,r}),Object.create||(Object.create=function(t){function i(){}return i.prototype=t,new i}),Object.construct||(Object.construct=function(t){var i=Object.create(t);return i.initialize&&i.initialize.apply(i,[].slice.call(arguments,1)),i}),Object.extend||(Object.extend=function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e]);return t}),window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,i){window.setTimeout(t,1e3/60)}),$=Element=function(){var t={_extended:!0,showIf:function(t){t?this.show():this.hide()},show:function(){this.style.display=""},hide:function(){this.style.display="none"},update:function(t){this.innerHTML=t},hasClassName:function(t){return RegExp("(^|s*)"+t+"(s*|$)").test(this.className)},addClassName:function(t){this.toggleClassName(t,!0)},removeClassName:function(t){this.toggleClassName(t,!1)},toggleClassName:function(t,i){var e=this.className.split(" "),n=e.indexOf(t);(i=void 0===i?n<0:i)&&n<0?e.push(t):!i&&n>=0&&e.splice(n,1),this.className=e.join(" ")}};return function(i){return"string"==typeof i&&(i=document.getElementById(i)),i._extended||Object.extend(i,t),i}}(),StateMachine={create:function(t){var i,e,n,s=t.target||{},r=t.events,a={};for(i=0;i<r.length;i++)a[n=(e=r[i]).name]=(a[n]||[]).concat(e.from),s[n]=this.buildEvent(n,e.from,e.to,s);if(s.current="none",s.is=function(t){return this.current==t},s.can=function(t){return a[t].indexOf(this.current)>=0},s.cannot=function(t){return!this.can(t)},t.initial){var o="string"==typeof t.initial?{state:t.initial}:t.initial;a[n=o.event||"startup"]=["none"],e=this.buildEvent(n,"none",o.state,s),o.defer?s[n]=e:e.call(s)}return s},buildEvent:function(t,i,e,n){return function(){if(this.cannot(t))throw"event "+t+" innapropriate in current state "+this.current;var i=this["onbefore"+t];if(!i||!1!==i.apply(this,arguments)){if(this.current!=e){var n=this["onleave"+this.current];n&&n.apply(this,arguments),this.current=e;var s=this["onenter"+e]||this["on"+e];s&&s.apply(this,arguments)}var r=this["onafter"+t]||this["on"+t];r&&r.apply(this,arguments)}}}},Game={compatible:function(){return Object.create&&Object.extend&&Function.bind&&document.addEventListener&&Game.ua.hasCanvas},start:function(t,i,e){if(Game.compatible())return Game.current=Object.construct(Game.Runner,t,i,e).game},ua:function(){var t=navigator.userAgent.toLowerCase(),i=t.indexOf("opera")>-1?"opera":null;i=(i=(i=(i=i||(t.indexOf("firefox")>-1?"firefox":null))||(t.indexOf("chrome")>-1?"chrome":null))||(t.indexOf("safari")>-1?"safari":null))||(t.indexOf("msie")>-1?"ie":null);try{var e="ie"==i?"msie (\\d)":i+"\\/(\\d\\.\\d)",n=t.match(RegExp(e,"i")),s=n?parseFloat(n[1]):null}catch(r){}return{full:t,name:i+(s?" "+s.toString():""),version:s,isFirefox:"firefox"==i,isChrome:"chrome"==i,isSafari:"safari"==i,isOpera:"opera"==i,isIE:"ie"==i,hasCanvas:document.createElement("canvas").getContext,hasAudio:"undefined"!=typeof Audio,hasTouch:"ontouchstart"in window}}(),addEvent:function(t,i,e){$(t).addEventListener(i,e,!1)},removeEvent:function(t,i,e){$(t).removeEventListener(i,e,!1)},windowWidth:function(){return window.innerWidth||document.documentElement.offsetWidth},windowHeight:function(){return window.innerHeight||document.documentElement.offsetHeight},ready:function(t){Game.compatible()&&Game.addEvent(document,"DOMContentLoaded",t)},renderToCanvas:function(t,i,e,n){return(n=n||document.createElement("canvas")).width=t,n.height=i,e(n.getContext("2d")),n},loadScript:function(t,i){var e=document.getElementsByTagName("head")[0],n=document.createElement("script");e.appendChild(n),Game.ua.isIE?n.onreadystatechange=function(t){"loaded"==t.currentTarget.readyState&&i(t.currentTarget)}:n.onload=function(t){i(t.currentTarget)},n.type="text/javascript",n.src=t},loadImages:function(t,i){var e={},n=t?t.length:0;if(0==n)i(e);else for(var s=0;s<t.length;s++){var r=t[s],a=document.createElement("img");e[r]=a,Game.addEvent(a,"load",function(){0==--n&&i(e)}),a.src=r}},loadSounds:function(t){if(t=t||{},"undefined"==typeof soundManager){var i=t.path||"sound/soundmanager2-nodebug-jsmin.js",e=t.swf||"sound/swf";window.SM2_DEFER=!0,Game.loadScript(i,function(){window.soundManager=new SoundManager,soundManager.useHighPerformance=!0,soundManager.useFastPolling=!0,soundManager.url=e,soundManager.defaultOptions.volume=50,soundManager.onready(function(){Game.loadSounds(t)}),soundManager.beginDelayedInit()})}else{var n=[];for(var s in t.sounds)n.push(soundManager.createSound({id:s,url:t.sounds[s]}));t.onload&&t.onload(n)}},random:function(t,i){return t+Math.random()*(i-t)},randomInt:function(t,i){return Math.floor(Math.random()*i)+t},randomChoice:function(t){return t[Math.round(Game.random(0,t.length-1))]},randomBool:function(){return Game.randomChoice([!0,!1])},timestamp:function(){return new Date().getTime()},THREESIXTY:2*Math.PI,KEY:{BACKSPACE:8,TAB:9,RETURN:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,HOME:36,END:35,PAGEUP:33,PAGEDOWN:34,INSERT:45,ZERO:48,ONE:49,TWO:50,A:65,D:68,L:76,P:80,Q:81,TILDA:192},Math:{bound:function(t){return t.radius?(t.w=2*t.radius,t.h=2*t.radius,t.left=t.x-t.radius,t.right=t.x+t.radius,t.top=t.y-t.radius,t.bottom=t.y+t.radius):(t.left=t.x,t.right=t.x+t.w,t.top=t.y,t.bottom=t.y+t.h),t},overlap:function(t,i,e){if(t.right<i.left||t.left>i.right||t.top>i.bottom||t.bottom<i.top)return!1;if(!e)return!0;var n=Math.max(t.left,i.left),s=Math.min(t.right,i.right),r=Math.max(t.top,i.top),a=Math.min(t.bottom,i.bottom);return{x:n,y:r,w:s-n,h:a-r,left:n,right:s,top:r,bottom:a}},normalize:function(t,i){return t.m=this.magnitude(t.x,t.y),0==t.m?t.x=t.y=t.m=0:(t.m=t.m/(i||1),t.x=t.x/t.m,t.y=t.y/t.m,t.m=t.m/t.m),t},magnitude:function(t,i){return Math.sqrt(t*t+i*i)},move:function(t,i,e,n,s){var r=e*s,a=n*s;return{x:t+r,y:i+a,dx:e,dy:n,nx:r,ny:a}},accelerate:function(t,i,e,n,s,r){var a=t+r*e+s*r*r*.5,o=i+r*n+s*r*r*.5;return{nx:a-t,ny:o-i,x:a,y:o,dx:e+s*r*(e>0?1:-1),dy:n+s*r*(n>0?1:-1)}},intercept:function(t,i,e,n,s,r,a,o,h){var u=(o-r)*(e-t)-(a-s)*(n-i);if(0!=u){var d=((a-s)*(i-r)-(o-r)*(t-s))/u;if(d>=0&&d<=1){var f=((e-t)*(i-r)-(n-i)*(t-s))/u;if(f>=0&&f<=1)return{x:t+d*(e-t),y:i+d*(n-i),d:h}}}return null},ballIntercept:function(t,i,e,n){var s;return e<0?s=Game.Math.intercept(t.x,t.y,t.x+e,t.y+n,i.right+t.radius,i.top-t.radius,i.right+t.radius,i.bottom+t.radius,"right"):e>0&&(s=Game.Math.intercept(t.x,t.y,t.x+e,t.y+n,i.left-t.radius,i.top-t.radius,i.left-t.radius,i.bottom+t.radius,"left")),!s&&(n<0?s=Game.Math.intercept(t.x,t.y,t.x+e,t.y+n,i.left-t.radius,i.bottom+t.radius,i.right+t.radius,i.bottom+t.radius,"bottom"):n>0&&(s=Game.Math.intercept(t.x,t.y,t.x+e,t.y+n,i.left-t.radius,i.top-t.radius,i.right+t.radius,i.top-t.radius,"top"))),s}},Runner:{initialize:function(t,i,e){this.cfg=Object.extend(i.Defaults||{},e||{}),this.fps=this.cfg.fps||60,this.interval=1e3/this.fps,this.canvas=$(t),this.bounds=this.canvas.getBoundingClientRect(),this.width=this.cfg.width||this.canvas.offsetWidth,this.height=this.cfg.height||this.canvas.offsetHeight,this.front=this.canvas,this.front.width=this.width,this.front.height=this.height,this.front2d=this.front.getContext("2d"),this.addEvents(),this.resetStats(),this.resize(),this.game=Object.construct(i,this,this.cfg),this.cfg.state&&StateMachine.create(Object.extend({target:this.game},this.cfg.state)),this.initCanvas()},start:function(){this.lastFrame=Game.timestamp(),this.timer=setInterval(this.loop.bind(this),this.interval)},stop:function(){clearInterval(this.timer)},loop:function(){this._start=Game.timestamp(),this.update((this._start-this.lastFrame)/1e3),this._middle=Game.timestamp(),this.draw(),this._end=Game.timestamp(),this.updateStats(this._middle-this._start,this._end-this._middle),this.lastFrame=this._start},initCanvas:function(){this.game&&this.game.initCanvas&&this.game.initCanvas(this.front2d)},update:function(t){this.game.update(t)},draw:function(){this.game.draw(this.front2d),this.drawStats(this.front2d)},resetStats:function(){this.stats={count:0,fps:0,update:0,draw:0,frame:0}},updateStats:function(t,i){this.cfg.stats&&(this.stats.update=Math.max(1,t),this.stats.draw=Math.max(1,i),this.stats.frame=this.stats.update+this.stats.draw,this.stats.count=this.stats.count==this.fps?0:this.stats.count+1,this.stats.fps=Math.min(this.fps,1e3/this.stats.frame))},strings:{frame:"frame: ",fps:"fps: ",update:"update: ",draw:"draw: ",ms:"ms"},drawStats:function(t){this.cfg.stats&&(t.fillText(this.strings.frame+Math.round(this.stats.count),this.width-100,this.height-60),t.fillText(this.strings.fps+Math.round(this.stats.fps),this.width-100,this.height-50),t.fillText(this.strings.update+Math.round(this.stats.update)+this.strings.ms,this.width-100,this.height-40),t.fillText(this.strings.draw+Math.round(this.stats.draw)+this.strings.ms,this.width-100,this.height-30))},addEvents:function(){Game.addEvent(document,"keydown",this.onkeydown.bind(this)),Game.addEvent(document,"keyup",this.onkeyup.bind(this)),Game.addEvent(window,"resize",this.onresize.bind(this))},onresize:function(){this.stop(),this.onresizeTimer&&clearTimeout(this.onresizeTimer),this.onresizeTimer=setTimeout(this.onresizeend.bind(this),50)},onresizeend:function(){this.resize(),this.start()},resize:function(){(this.width!=this.canvas.offsetWidth||this.height!=this.front.offsetHeight)&&(this.width=this.front.width=this.front.offsetWidth,this.height=this.front.height=this.front.offsetHeight,this.game&&this.game.onresize&&this.game.onresize(this.width,this.height),this.initCanvas())},onkeydown:function(t){return this.game.onkeydown?this.game.onkeydown(t.keyCode):this.cfg.keys?this.onkey(t.keyCode,"down"):void 0},onkeyup:function(t){return this.game.onkeyup?this.game.onkeyup(t.keyCode):this.cfg.keys?this.onkey(t.keyCode,"up"):void 0},onkey:function(t,i){var e,n,s=this.game.current;for(e=0;e<this.cfg.keys.length;e++)(n=this.cfg.keys[e]).mode=n.mode||"up",(n.key==t||n.keys&&n.keys.indexOf(t)>=0)&&(!n.state||n.state==s)&&n.mode==i&&n.action.call(this.game)},storage:function(){try{return this.localStorage=this.localStorage||window.localStorage||{}}catch(t){return this.localStorage={}}},alert:function(t){return this.stop(),result=window.alert(t),this.start(),result},confirm:function(t){return this.stop(),result=window.confirm(t),this.start(),result}}};