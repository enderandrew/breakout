Breakout={Defaults:{level:{name:""},fps:60,stats:!1,score:{lives:{initial:3,max:5}},court:{xchunks:30,ychunks:25},ball:{radius:.3,defaultRadius:.3,speed:15,defaultSpeed:15,labels:{3:{text:"ready...",fill:"#FF2121",stroke:"black",font:"bold 28pt arial"},2:{text:"set..",fill:"white",stroke:"black",font:"bold 28pt arial"},1:{text:"go!",fill:"#00B500",stroke:"black",font:"bold 28pt arial"}}},paddle:{width:6,defaultWidth:6,height:1,speed:20},color:{background:"rgba(200, 200, 200, 0.5)",foreground:"white",border:"#222",wall:"#333",ball:"white",paddle:"#4d2f5d",score:"#EFD279",highscore:"#EFD279"},state:{initial:"menu",events:[{name:"play",from:"menu",to:"game"},{name:"abandon",from:"game",to:"menu"},{name:"lose",from:"game",to:"menu"}]},powerup:{droprate:{low:0,high:40,goal:0}},keys:[{keys:[Game.KEY.LEFT,Game.KEY.A],mode:"down",action:function(){this.paddle.moveLeft()}},{keys:[Game.KEY.RIGHT,Game.KEY.D],mode:"down",action:function(){this.paddle.moveRight()}},{keys:[Game.KEY.LEFT,Game.KEY.A],action:function(){this.paddle.stopMovingLeft()}},{keys:[Game.KEY.RIGHT,Game.KEY.D],action:function(){this.paddle.stopMovingRight()}},{keys:[Game.KEY.SPACE,Game.KEY.RETURN],state:"menu",action:function(){this.play()}},{keys:[Game.KEY.SPACE,Game.KEY.RETURN],state:"game",action:function(){this.ball.launchNow()}},{key:Game.KEY.ESC,state:"game",action:function(){this.abandon()}},{key:Game.KEY.UP,state:"menu",action:function(){this.nextLevel()}},{key:Game.KEY.DOWN,state:"menu",action:function(){this.prevLevel()}}],sounds:{brick:"./sound/breakout/brick.mp3",paddle:"./sound/breakout/paddle.mp3",go:"./sound/breakout/go.mp3",levelup:"./sound/breakout/levelup.mp3",loselife:"./sound/breakout/loselife.mp3",gameover:"./sound/breakout/gameover.mp3"}},initialize:function(t,e){this.cfg=e,this.runner=t,this.width=t.width,this.height=t.height,this.storage=t.storage(),this.color=e.color,this.sound="true"==this.storage.sound,this.court=Object.construct(Breakout.Court,this,e.court),this.paddle=Object.construct(Breakout.Paddle,this,e.paddle),this.ball=Object.construct(Breakout.Ball,this,e.ball),this.score=Object.construct(Breakout.Score,this,e.score),this.powerup=Object.construct(Breakout.Powerups,this,e,this.ball,this.paddle,this.score,this.game,e.powerups),Game.loadSounds({sounds:e.sounds})},onstartup:function(){this.addEvents(),this.runner.start()},addEvents:function(){Game.addEvent("prev","click",this.prevLevel.bind(this,!1)),Game.addEvent("next","click",this.nextLevel.bind(this,!1)),Game.addEvent("sound","change",this.toggleSound.bind(this,!1)),Game.addEvent("instructions","touchstart",this.play.bind(this)),Game.addEvent(this.runner.canvas,"touchmove",this.ontouchmove.bind(this)),Game.addEvent(document.body,"touchmove",function(t){t.preventDefault()}),Game.addEvent("upload","click",this.load.bind(this,!0))},toggleSound:function(){this.storage.sound=this.sound=!this.sound},update:function(t){this.court.update(t),this.paddle.update(t),this.ball.update(t),this.score.update(t)},draw:function(t){t.save(),t.clearRect(0,0,this.width,this.height),t.fillStyle=this.color.background,t.fillRect(0,0,this.width,this.height),this.court.draw(t),this.paddle.draw(t),this.ball.draw(t),this.score.draw(t),t.restore()},onresize:function(t,e){this.width=t,this.height=e,this.court.resize(),this.paddle.reset(),this.ball.reset()},onmenu:function(){this.resetLevel(),this.paddle.reset(),this.ball.reset(),this.refreshDOM()},ongame:function(){this.refreshDOM(),this.score.reset(),this.ball.reset({launch:!0})},onlose:function(){this.playSound("gameover")},onleavegame:function(){this.score.save(),this.score.resetLives()},onbeforeabandon:function(){return this.runner.confirm("Abandon game?")},loseBall:function(){this.powerup.resetPowerups(),this.playSound("loselife"),this.score.loseLife()?this.lose():this.ball.reset({launch:!0})},winLevel:function(){this.playSound("levelup"),this.score.gainLife(),this.nextLevel(!0),this.ball.reset({launch:!0})},hitBrick:function(t){this.powerup.rollForPowerup(),this.playSound("brick"),this.court.remove(t),this.score.increase(t.score),this.ball.speed+=10*(1-this.ball.speed/this.ball.maxspeed),this.court.empty()&&this.winLevel()},resetLevel:function(){this.setLevel()},setLevel:function(t){t=(t=void 0===t?this.storage.level?parseInt(this.storage.level):0:t)<Breakout.Levels.length?t:0,this.court.reset(t),this.storage.level=this.level=t,this.determineLevelName(),this.powerup.resetPowerups(),this.refreshDOM()},canPrevLevel:function(){return this.is("menu")&&this.level>0},canNextLevel:function(){return this.is("menu")&&this.level<Breakout.Levels.length-1},prevLevel:function(t){(t||this.canPrevLevel())&&this.setLevel(this.level-1)},nextLevel:function(t){(t||this.canNextLevel())&&this.setLevel(this.level+1)},determineLevelName:function(){this.level?this.setLevelName(Breakout.Levels[this.storage.level].name):this.setLevelName(Breakout.Levels[this.level].name)},setLevelName:function(t){this.Defaults.level.name=t,this.setLevelLabel()},setLevelLabel:function(){document.getElementById("label").innerHTML=this.getLevelName()},getLevelName:function(){return this.Defaults.level.name},load:function(t,e){if(e){let i=prompt("Paste level code:");i&&(this.readLevel(i),this.setLevel(0))}},readLevel:function(t){try{var e=atob(t).trim();if(this.isValidJson(e)){var i=JSON.parse(e);this.isValidLevel(i)&&Breakout.Levels.unshift(i)}}catch{alert("Level code provided could not be")}},isValidLevel:function(t){return!!t.name&&!!t.bricks||(alert("Level code provided is missing key attribute."),!1)},isValidJson:function(t){try{JSON.parse(t)}catch(e){return alert("Level code provided could not be parsed."),!1}return!0},initCanvas:function(t){t.fillStyle=this.color.foreground,t.strokeStyle=this.color.foreground,t.lineWidth=1,this.score.measure(t)},refreshDOM:function(){$("instructions").className=Game.ua.hasTouch?"touch":"keyboard",$("instructions").showIf(this.is("menu")),$("prev").toggleClassName("disabled",!this.canPrevLevel()),$("next").toggleClassName("disabled",!this.canNextLevel()),$("level").update(this.level+1),$("sound").checked=this.sound},playSound:function(t){soundManager&&this.sound&&soundManager.play(t)},ontouchmove:function(t){1==t.targetTouches.length&&this.paddle.place(t.targetTouches[0].pageX-this.runner.bounds.left-this.paddle.w/2)},Powerups:{powerups:{description:"Powerups have a 2.5% droprate when destroying blocks and offer several perks.",list:[{name:"Big Paddle",used:!1,enabled:!0,description:"Makes your paddle 2x longer",funct:function(t,e,i){var s=t.x-Breakout.Defaults.paddle.defaultWidth/2,h=t.y;Breakout.Defaults.paddle.width=2*Breakout.Defaults.paddle.defaultWidth,t.reset(),t.setpos(s,h)}},{name:"Small Paddle",used:!1,enabled:!0,description:"Shrinks your paddle in half",funct:function(t,e,i){var s=t.x+Breakout.Defaults.paddle.defaultWidth/2,h=t.y;Breakout.Defaults.paddle.width=Breakout.Defaults.paddle.defaultWidth/2,t.reset(),t.setpos(s,h)}},{name:"Extra Life",used:!1,enabled:!0,description:"Gives you an extra life",funct:function(t,e,i){this.active=!0,e.gainLife()}},{name:"Fireball",used:!1,enabled:!0,active:!1,description:"Melts everything in it's path",funct:function(t,e,i){this.active=!0}},{name:"Tripleball",used:!1,enabled:!1,active:!1,description:"BALLS!",funct:function(t,e,i,s){i.multiply(s)}},{name:"BigBall",used:!1,enabled:!0,active:!1,description:"You have REALLY big balls!",funct:function(t,e,i){i.grow()}},{name:"SmallBall",used:!1,enabled:!0,active:!1,description:"Did you take steroids? You have small balls.",funct:function(t,e,i){i.shrink()}},{name:"FastBall",used:!1,enabled:!0,active:!1,description:"Go Speed Racer!",funct:function(t,e,i){i.fast()}},{name:"SlowBall",used:!1,enabled:!0,active:!1,description:"That is a little easier!",funct:function(t,e,i){i.slow()}}]},initialize:function(t,e,i,s,h){this.game=t,this.cfg=e,this.ball=i,this.paddle=s,this.score=h},isFireballActive:function(){return this.powerups.list.find(t=>"Fireball"===t.name).active},rollForPowerup:function(){this.powerups.list[4].funct(this.paddle,this.score,this.ball,this.cfg),Math.round(Game.randomInt(Breakout.Defaults.powerup.droprate.low,Breakout.Defaults.powerup.droprate.high))==Breakout.Defaults.powerup.droprate.goal&&this.givePowerup()},givePowerup:function(){var t=this.findPowerup();if(t.length>0){var e=Game.randomChoice(t);document.getElementById("powerups").innerHTML=e.name+": "+e.description,e.funct(this.paddle,this.score,this.ball),e.used=!0}},isEnabledPowerup:function(){return this.powerups.list.some(t=>t.enabled)},isActivePowerup:function(){return this.powerups.list.some(t=>t.active)},isUsedPowerup:function(){return this.powerups.list.some(t=>t.used)},findPowerup:function(){var t=this.powerups.list.filter(t=>t.enabled);return(t=t.filter(t=>!0!==t.active)).filter(t=>!1==t.used)},resetPowerup:function(t){t.used=!1},resetPowerups:function(){this.powerups.list.forEach(this.resetPowerup),Breakout.Defaults.paddle.width=Breakout.Defaults.paddle.defaultWidth,this.paddle.reset(),this.paddle.setpos(this.game.width/2-Breakout.Defaults.paddle.width,this.paddle.y),this.powerups.list.find(t=>"Fireball"===t.name).active=!1,document.getElementById("powerups").innerHTML=""}},Score:{initialize:function(t,e){this.game=t,this.cfg=e,this.load(),this.reset()},reset:function(){this.set(0),this.resetLives()},set:function(t){this.score=this.vscore=t,this.rerender=!0},increase:function(t){this.score=this.score+t,this.rerender=!0},format:function(t){return("0000000"+t).slice(-7)},load:function(){this.highscore=this.game.storage.highscore?parseInt(this.game.storage.highscore):1337},save:function(){this.score>this.highscore&&(this.game.storage.highscore=this.highscore=this.score)},resetLives:function(){this.setLives(this.cfg.lives.initial)},setLives:function(t){this.lives=t,this.rerender=!0},gainLife:function(){this.setLives(Math.min(this.cfg.lives.max,this.lives+1))},loseLife:function(){return this.setLives(this.lives-1),0==this.lives},update:function(t){this.vscore<this.score&&(this.vscore=Math.min(this.score,this.vscore+10),this.rerender=!0)},measure:function(t){this.left=this.game.court.left,this.top=this.game.court.top-2*this.game.court.wall.size,this.width=this.game.court.width,this.height=2*this.game.court.wall.size,this.scorefont="bold "+Math.max(9,this.game.court.wall.size-2)+"pt arial",this.highfont=""+Math.max(9,this.game.court.wall.size-8)+"pt arial",t.save(),t.font=this.scorefont,this.scorewidth=t.measureText(this.format(0)).width,t.font=this.highfont,this.highwidth=t.measureText("HIGH SCORE: "+this.format(0)).width,t.restore(),this.rerender=!0},draw:function(t){this.rerender&&(this.canvas=Game.renderToCanvas(this.width,this.height,this.render.bind(this),this.canvas),this.rerender=!1),t.drawImage(this.canvas,this.left,this.top)},render:function(t){var e,i,s,h=this.game.is("game")&&this.score>this.highscore;t.textBaseline="middle",t.fillStyle=this.game.color.score,t.font=this.scorefont,e=this.format(this.vscore),t.fillText(e,0,this.height/2),t.fillStyle=h?this.game.color.score:this.game.color.highscore,e="HIGH SCORE: "+this.format(h?this.score:this.highscore),t.font=this.highfont,i=t.measureText(e).width,t.fillText(e,this.width-i,this.height/2),s={game:this.game,w:1.5*this.game.court.chunk,h:2*this.game.court.chunk/3},t.translate(this.scorewidth+20,(this.height-s.h)/2);for(var o=0;o<this.lives;o++)this.game.paddle.render.call(s,t),t.translate(s.w+5,0)}},Court:{initialize:function(t,e){this.game=t,this.cfg=e},reset:function(t){var e,i,s,h,o,l,a,r=Breakout.Levels[t],c=Math.min(r.bricks.length,this.cfg.ychunks);for(l=0,this.bricks=[];l<c;l++)for(o=0,s=(this.cfg.ychunks-l)*5,e=r.bricks[l]+" ",i=null,a=Math.min(e.length,this.cfg.xchunks+1);o<a;o++)h=e[o],i&&i.c==h?i.pos.x2=o:i&&i.c!=h&&(this.bricks.push(i),i=null),i||" "==h||(i={isbrick:!0,hit:!1,c:h,pos:{x1:o,x2:o,y:l},score:s,color:r.colors[h.toLowerCase()]});this.numbricks=this.bricks.length,this.numhits=0,this.resize()},resize:function(){for(n=0,this.chunk=Math.floor(Math.min(this.game.width,this.game.height)/(Math.max(this.cfg.xchunks,this.cfg.ychunks)+4)),this.width=this.cfg.xchunks*this.chunk,this.height=this.cfg.ychunks*this.chunk,this.left=Math.floor((this.game.width-this.width)/2),this.top=Math.floor((this.game.height-this.height)/2),this.right=this.left+this.width,this.bottom=this.top+this.height,this.wall={},this.wall.size=this.chunk,this.wall.top=Game.Math.bound({x:this.left-this.wall.size,y:this.top-2*this.wall.size,w:this.width+2*this.wall.size,h:2*this.wall.size}),this.wall.left=Game.Math.bound({x:this.left-this.wall.size,y:this.top-2*this.wall.size,w:this.wall.size,h:2*this.wall.size+this.height}),this.wall.right=Game.Math.bound({x:this.right,y:this.top-2*this.wall.size,w:this.wall.size,h:2*this.wall.size+this.height});n<this.numbricks;n++)(brick=this.bricks[n]).x=this.left+brick.pos.x1*this.chunk,brick.y=this.top+brick.pos.y*this.chunk,brick.w=(brick.pos.x2-brick.pos.x1+1)*this.chunk,brick.h=this.chunk,Game.Math.bound(brick);this.rerender=!0},update:function(t){},draw:function(t){this.rerender&&(this.canvas=Game.renderToCanvas(this.game.width,this.game.height,this.render.bind(this),this.canvas),this.rerender=!1),t.drawImage(this.canvas,0,0)},render:function(t){var e,i;for(t.translate(.5,.5),t.strokeStyle=this.game.color.border,t.lineWidth=1,e=0;e<this.numbricks;e++)(i=this.bricks[e]).hit||(t.fillStyle=i.color,t.fillRect(i.x,i.y,i.w,i.h),t.strokeRect(i.x,i.y,i.w,i.h));t.fillStyle=this.game.color.wall,t.lineWidth=2,t.beginPath(),t.moveTo(this.wall.top.left,this.wall.top.top),t.lineTo(this.wall.top.right,this.wall.top.top),t.lineTo(this.wall.top.right,this.wall.right.bottom),t.lineTo(this.wall.right.left,this.wall.right.bottom),t.lineTo(this.wall.right.left,this.wall.top.bottom),t.lineTo(this.wall.left.right,this.wall.top.bottom),t.lineTo(this.wall.left.right,this.wall.left.bottom),t.lineTo(this.wall.left.left,this.wall.left.bottom),t.lineTo(this.wall.top.left,this.wall.top.top),t.fill(),t.stroke(),t.closePath()},remove:function(t){t.hit=!0,this.numhits++,this.rerender=!0},empty:function(){return this.numhits==this.numbricks}},Ball:{initialize:function(t,e){this.game=t,this.cfg=e},reset:function(t){this.radius=this.cfg.radius*this.game.court.chunk,this.speed=this.cfg.speed*this.game.court.chunk,this.maxspeed=1.5*this.speed,this.color=this.game.color.ball,this.moveToPaddle(),this.setdir(0,0),this.clearLaunch(),this.hitTargets=[this.game.paddle,this.game.court.wall.top,this.game.court.wall.left,this.game.court.wall.right,].concat(this.game.court.bricks),t&&t.launch&&this.launch()},resize:function(){this.radius=this.cfg.radius*this.game.court.chunk,this.speed=this.cfg.speed*this.game.court.chunk},grow:function(){this.radius=2*Breakout.Defaults.ball.defaultRadius*this.game.court.chunk},shrink:function(){this.radius=Breakout.Defaults.ball.defaultRadius/2*this.game.court.chunk},fast:function(){this.speed=1.5*Breakout.Defaults.ball.defaultSpeed*this.game.court.chunk},slow:function(){this.speed=Breakout.Defaults.ball.defaultSpeed/1.5*this.game.court.chunk},multiply:function(t){this.ball=Object.construct(Breakout.Ball,this,t.ball),this.clearLaunch(),this.launch()},moveToPaddle:function(){this.setpos(this.game.paddle.left+this.game.paddle.w/2,this.game.court.bottom-this.game.paddle.h-this.radius)},setpos:function(t,e){this.x=t,this.y=e,Game.Math.bound(this)},setdir:function(t,e){var i=Game.Math.normalize({x:t,y:e});this.dx=i.x,this.dy=i.y,this.moving=0!=i.m},launch:function(){(!this.moving||this.countdown)&&(this.countdown=void 0===this.countdown||null==this.countdown?3:this.countdown-1,this.countdown>0?(this.label=this.launchLabel(this.countdown),this.delayTimer=setTimeout(this.launch.bind(this),1e3),1==this.countdown&&this.setdir(1,-1)):this.clearLaunch())},launchNow:function(){this.moving||(this.clearLaunch(),this.setdir(1,-1))},launchLabel:function(t){var e=this.cfg.labels[t],i=this.game.runner.front2d;i.save(),i.font=e.font,i.fillStyle=e.fill,i.strokeStyle=e.stroke,i.lineWidth=.5;var s=i.measureText(e.text).width;return i.restore(),e.x=this.game.court.left+(this.game.court.width-s)/2,e.y=this.game.paddle.top-60,e},clearLaunch:function(){this.delayTimer&&(clearTimeout(this.delayTimer),this.delayTimer=this.label=this.countdown=null)},update:function(t){if(!this.moving)return this.moveToPaddle();for(var e,i,s,h=Game.Math.move(this.x,this.y,this.dx*this.speed,this.dy*this.speed,t),o=1/0,l=null,a=0;a<this.hitTargets.length;a++)!(s=this.hitTargets[a]).hit&&(i=Game.Math.ballIntercept(this,s,h.nx,h.ny))&&(e=Game.Math.magnitude(i.x-this.x,i.y-this.y))<o&&(o=e,l={item:s,point:i});if(l){if(l.item.isbrick&&(this.game.hitBrick(l.item),!this.moving))return;switch(l.item==this.game.paddle&&"top"==l.point.d&&(h.dx=this.speed*(l.point.x-(this.game.paddle.left+this.game.paddle.w/2))/(this.game.paddle.w/2),this.game.playSound("paddle")),this.setpos(l.point.x,l.point.y),l.point.d){case"left":case"right":l.item.isbrick&&this.game.powerup.isFireballActive()?this.setdir(h.dx,h.dy):this.setdir(-h.dx,h.dy);break;case"top":case"bottom":l.item.isbrick&&this.game.powerup.isFireballActive()?this.setdir(h.dx,h.dy):this.setdir(h.dx,-h.dy)}var r=t*(o/Game.Math.magnitude(h.nx,h.ny));return this.update(t-r)}h.x<0||h.y<0||h.x>this.game.width||h.y>this.game.height?this.game.loseBall():(this.setpos(h.x,h.y),this.setdir(h.dx,h.dy))},draw:function(t){t.fillStyle=this.color,t.beginPath(),t.arc(this.x,this.y,this.radius,0,Game.THREESIXTY,!0),t.fill(),t.stroke(),t.closePath(),this.label&&(t.font=this.label.font,t.fillStyle=this.label.fill,t.strokeStyle=this.label.stroke,t.lineWidth=.5,t.fillText(this.label.text,this.label.x,this.label.y),t.strokeText(this.label.text,this.label.x,this.label.y))}},Paddle:{initialize:function(t,e){this.game=t,this.cfg=e},reset:function(){this.speed=this.cfg.speed*this.game.court.chunk,this.w=this.cfg.width*this.game.court.chunk,this.h=this.cfg.height*this.game.court.chunk,this.minX=this.game.court.left,this.maxX=this.game.court.right-this.w,this.setpos(this.game.width/2-Breakout.Defaults.paddle.width,this.game.court.bottom-this.h),this.setdir(0),this.rerender=!0},resize:function(t,e){this.w=this.cfg.width*this.game.court.chunk,this.h=this.cfg.height*this.game.court.chunk,this.minX=this.game.court.left,this.maxX=this.game.court.right-this.w,this.setpos(t,e)},setpos:function(t,e){this.x=t,this.y=e,Game.Math.bound(this)},setdir:function(t){this.dleft=t<0?-t:0,this.dright=t>0?t:0},place:function(t){this.setpos(Math.min(this.maxX,Math.max(this.minX,t)),this.y)},update:function(t){var e=this.dright-this.dleft;0!=e&&this.place(this.x+e*t*this.speed)},draw:function(t){this.rerender&&(this.canvas=Game.renderToCanvas(this.w,this.h,this.render.bind(this)),this.rerender=!1),t.drawImage(this.canvas,this.x,this.y)},render:function(t){var e=t.createLinearGradient(0,this.h,0,0);e.addColorStop(.36,this.game.color.paddle),e.addColorStop(.68,this.game.color.paddle),e.addColorStop(.84,this.game.color.paddle);var i=this.h/2;t.fillStyle=e,t.strokeStyle=this.game.color.border,t.beginPath(),t.moveTo(i,0),t.lineTo(this.w-i,0),t.arcTo(this.w,0,this.w,i,i),t.lineTo(this.w,this.h-i),t.arcTo(this.w,this.h,this.w-i,this.h,i),t.lineTo(i,this.h),t.arcTo(0,this.h,0,this.h-i,i),t.lineTo(0,i),t.arcTo(0,0,i,0,i),t.fill(),t.stroke(),t.closePath()},moveLeft:function(){this.dleft=1},moveRight:function(){this.dright=1},stopMovingLeft:function(){this.dleft=0},stopMovingRight:function(){this.dright=0}}};